# NewSQL –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö

NewSQL - —ç—Ç–æ –∫–∞—Ç–µ–≥–æ—Ä–∏—è —Å–æ–≤—Ä–µ–º–µ–Ω–Ω—ã—Ö –°–£–ë–î, –∫–æ—Ç–æ—Ä—ã–µ –æ–±—ä–µ–¥–∏–Ω—è—é—Ç –ª—É—á—à–µ–µ –∏–∑ SQL –∏ NoSQL –º–∏—Ä–æ–≤: —Å—Ç—Ä–æ–≥–∞—è –∫–æ–Ω—Å–∏—Å—Ç–µ–Ω—Ç–Ω–æ—Å—Ç—å –∏ SQL –∑–∞–ø—Ä–æ—Å—ã —Ç—Ä–∞–¥–∏—Ü–∏–æ–Ω–Ω—ã—Ö –±–∞–∑ + –≥–æ—Ä–∏–∑–æ–Ω—Ç–∞–ª—å–Ω–æ–µ –º–∞—Å—à—Ç–∞–±–∏—Ä–æ–≤–∞–Ω–∏–µ NoSQL.

---

## üéØ –ß—Ç–æ —Ç–∞–∫–æ–µ NewSQL?

**NewSQL = SQL + –†–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–Ω–æ—Å—Ç—å**

```
Traditional SQL         NoSQL               NewSQL
(PostgreSQL)           (MongoDB)           (CockroachDB)
     ‚îÇ                     ‚îÇ                     ‚îÇ
     ‚îú‚îÄ SQL ‚úÖ             ‚îú‚îÄ SQL ‚ùå             ‚îú‚îÄ SQL ‚úÖ
     ‚îú‚îÄ ACID ‚úÖ            ‚îú‚îÄ ACID ‚ö†Ô∏è            ‚îú‚îÄ ACID ‚úÖ
     ‚îú‚îÄ –°—Ö–µ–º–∞ ‚úÖ           ‚îú‚îÄ –°—Ö–µ–º–∞ ‚ùå           ‚îú‚îÄ –°—Ö–µ–º–∞ ‚úÖ
     ‚îú‚îÄ –ú–∞—Å—à—Ç–∞–±. ‚ùå        ‚îú‚îÄ –ú–∞—Å—à—Ç–∞–±. ‚úÖ        ‚îú‚îÄ –ú–∞—Å—à—Ç–∞–±. ‚úÖ
     ‚îî‚îÄ –†–∞—Å–ø—Ä–µ–¥. ‚ùå        ‚îî‚îÄ –†–∞—Å–ø—Ä–µ–¥. ‚úÖ        ‚îî‚îÄ –†–∞—Å–ø—Ä–µ–¥. ‚úÖ
```

### –ö–ª—é—á–µ–≤—ã–µ —Ö–∞—Ä–∞–∫—Ç–µ—Ä–∏—Å—Ç–∏–∫–∏:

1. **SQL —Å–∏–Ω—Ç–∞–∫—Å–∏—Å** - —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã–π SQL, –ø—Ä–∏–≤—ã—á–Ω—ã–π —Ä–∞–∑—Ä–∞–±–æ—Ç—á–∏–∫–∞–º
2. **ACID —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏** - –ø–æ–ª–Ω–∞—è –ø–æ–¥–¥–µ—Ä–∂–∫–∞, –¥–∞–∂–µ –≤ —Ä–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–Ω–æ–π —Å—Ä–µ–¥–µ
3. **–ì–æ—Ä–∏–∑–æ–Ω—Ç–∞–ª—å–Ω–æ–µ –º–∞—Å—à—Ç–∞–±–∏—Ä–æ–≤–∞–Ω–∏–µ** - –¥–æ–±–∞–≤–ª—è–π —Å–µ—Ä–≤–µ—Ä–∞, –Ω–µ –∞–ø–≥—Ä–µ–π–¥—å –∂–µ–ª–µ–∑–æ
4. **–ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è —Ä–µ–ø–ª–∏–∫–∞—Ü–∏—è** - –¥–∞–Ω–Ω—ã–µ –∫–æ–ø–∏—Ä—É—é—Ç—Å—è –º–µ–∂–¥—É —É–∑–ª–∞–º–∏
5. **High availability** - —Ä–∞–±–æ—Ç–∞–µ—Ç –¥–∞–∂–µ –ø—Ä–∏ –ø–∞–¥–µ–Ω–∏–∏ —É–∑–ª–æ–≤
6. **Strong consistency** - –Ω–µ eventual, –∞ —Å—Ç—Ä–æ–≥–∞—è –∫–æ–Ω—Å–∏—Å—Ç–µ–Ω—Ç–Ω–æ—Å—Ç—å

---

## üì¶ –û—Å–Ω–æ–≤–Ω—ã–µ NewSQL –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö

### 1. CockroachDB

**–û–ø–∏—Å–∞–Ω–∏–µ:** PostgreSQL-—Å–æ–≤–º–µ—Å—Ç–∏–º–∞—è —Ä–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–Ω–∞—è –ë–î, –≤–¥–æ—Ö–Ω–æ–≤–ª–µ–Ω–Ω–∞—è Google Spanner.

**–û—Å–æ–±–µ–Ω–Ω–æ—Å—Ç–∏:**
- PostgreSQL wire protocol (–ø–æ–¥–∫–ª—é—á–∞–µ—à—å—Å—è –∫–∞–∫ –∫ Postgres)
- –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π sharding –∏ rebalancing
- Multi-region deployment
- Serializable isolation –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é
- Open source (–±–µ—Å–ø–ª–∞—Ç–Ω–∞—è –∏ enterprise –≤–µ—Ä—Å–∏–∏)

**–ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞:**
```
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ              CockroachDB Cluster                     ‚îÇ
‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§
‚îÇ   Node 1    ‚îÇ   Node 2    ‚îÇ   Node 3    ‚îÇ   Node 4  ‚îÇ
‚îÇ   (US-East) ‚îÇ   (US-West) ‚îÇ   (EU)      ‚îÇ   (Asia)  ‚îÇ
‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îº‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îº‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îº‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§
‚îÇ   Range 1   ‚îÇ   Range 1   ‚îÇ   Range 1   ‚îÇ           ‚îÇ
‚îÇ   Range 2   ‚îÇ   Range 2   ‚îÇ             ‚îÇ   Range 2 ‚îÇ
‚îÇ             ‚îÇ   Range 3   ‚îÇ   Range 3   ‚îÇ   Range 3 ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¥‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¥‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¥‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
        ‚Üì               ‚Üì               ‚Üì
   3-way replication (–ø–æ —É–º–æ–ª—á–∞–Ω–∏—é)
```

**–ü—Ä–∏–º–µ—Ä –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è:**
```sql
-- –û–±—ã—á–Ω—ã–π PostgreSQL SQL!
CREATE TABLE users (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    email STRING UNIQUE NOT NULL,
    username STRING,
    created_at TIMESTAMP DEFAULT now()
);

-- –ò–Ω–¥–µ–∫—Å—ã —Ä–∞–±–æ—Ç–∞—é—Ç –∫–∞–∫ –≤ Postgres
CREATE INDEX idx_users_email ON users(email);

-- ACID —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏
BEGIN;
    INSERT INTO users (email, username) VALUES ('test@example.com', 'testuser');
    UPDATE accounts SET balance = balance - 100 WHERE user_id = 'test-id';
COMMIT;

-- Geo-partitioning –¥–ª—è latency optimization
ALTER TABLE users PARTITION BY LIST (region) (
    PARTITION us VALUES IN ('us-east', 'us-west'),
    PARTITION eu VALUES IN ('eu-west', 'eu-central'),
    PARTITION asia VALUES IN ('asia-pacific')
);
```

**–ö–æ–≥–¥–∞ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å:**
- ‚úÖ –ì–ª–æ–±–∞–ª—å–Ω–æ–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ (–ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏ –ø–æ –≤—Å–µ–º—É –º–∏—Ä—É)
- ‚úÖ –ö—Ä–∏—Ç–∏—á–Ω–∞ –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç—å (99.99%+)
- ‚úÖ –ù—É–∂–µ–Ω SQL + –≥–æ—Ä–∏–∑–æ–Ω—Ç–∞–ª—å–Ω–æ–µ –º–∞—Å—à—Ç–∞–±–∏—Ä–æ–≤–∞–Ω–∏–µ
- ‚úÖ –§–∏–Ω–∞–Ω—Å–æ–≤—ã–µ –¥–∞–Ω–Ω—ã–µ, —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏

**–ö–æ–≥–¥–∞ –ù–ï –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å:**
- ‚ùå –ú–∞–ª–µ–Ω—å–∫–∏–π –ø—Ä–æ–µ–∫—Ç (overkill)
- ‚ùå –û—á–µ–Ω—å –Ω–∏–∑–∫–∞—è latency –∫—Ä–∏—Ç–∏—á–Ω–∞ (distributed = –±–æ–ª—å—à–µ –∑–∞–¥–µ—Ä–∂–µ–∫)
- ‚ùå –û–≥—Ä–∞–Ω–∏—á–µ–Ω–Ω—ã–π –±—é–¥–∂–µ—Ç (–¥–æ—Ä–æ–∂–µ –æ–¥–Ω–æ–≥–æ Postgres)

### 2. Google Spanner

**–û–ø–∏—Å–∞–Ω–∏–µ:** –ü–µ—Ä–≤–∞—è NewSQL –ë–î –æ—Ç Google, –≤–¥–æ—Ö–Ω–æ–≤–µ–Ω–∏–µ –¥–ª—è CockroachDB.

**–û—Å–æ–±–µ–Ω–Ω–æ—Å—Ç–∏:**
- TrueTime API (–∞—Ç–æ–º–Ω—ã–µ —á–∞—Å—ã –¥–ª—è timestamp)
- External consistency (—Å—Ç—Ä–æ–∂–µ —á–µ–º serializable)
- Managed service (—Ç–æ–ª—å–∫–æ –≤ Google Cloud)
- –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ —à–∞—Ä–¥–∏—Ä–æ–≤–∞–Ω–∏–µ
- Multi-region –∏–∑ –∫–æ—Ä–æ–±–∫–∏

**–ü—Ä–∏–º–µ—Ä:**
```sql
-- Google Cloud SQL –¥–∏–∞–ª–µ–∫—Ç
CREATE TABLE users (
    user_id STRING(36) NOT NULL,
    email STRING(255) NOT NULL,
    created_at TIMESTAMP NOT NULL OPTIONS (allow_commit_timestamp=true)
) PRIMARY KEY (user_id);

-- Read-only transactions –¥–ª—è —Å–Ω–∏–∂–µ–Ω–∏—è latency
@{use_additional_parallelism=true}
SELECT * FROM users WHERE region = 'us-east';
```

**–¶–µ–Ω—ã:** –û—á–µ–Ω—å –¥–æ—Ä–æ–≥–æ (~$0.90 –∑–∞ —É–∑–µ–ª/—á–∞—Å + —Ö—Ä–∞–Ω–µ–Ω–∏–µ)

### 3. YugabyteDB

**–û–ø–∏—Å–∞–Ω–∏–µ:** Open-source NewSQL, PostgreSQL –∏ Cassandra —Å–æ–≤–º–µ—Å—Ç–∏–º–∞—è.

**–û—Å–æ–±–µ–Ω–Ω–æ—Å—Ç–∏:**
- –î–≤–∞ API: YSQL (PostgreSQL) –∏ YCQL (Cassandra)
- –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π failover
- Built-in sharding
- Open source (Apache 2.0)
- –ú–æ–∂–Ω–æ —Ä–∞–∑–≤–µ—Ä–Ω—É—Ç—å on-premise

**–ü—Ä–∏–º–µ—Ä:**
```sql
-- PostgreSQL-—Å–æ–≤–º–µ—Å—Ç–∏–º—ã–π YSQL
CREATE TABLE products (
    id SERIAL PRIMARY KEY,
    name VARCHAR(255),
    price DECIMAL(10,2),
    category_id INT
);

-- Sharding –ø–æ hash –∫–ª—é—á–∞ (–∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏)
-- –î–∞–Ω–Ω—ã–µ —Ä–∞—Å–ø—Ä–µ–¥–µ–ª—è—é—Ç—Å—è –ø–æ tablets
```

### 4. TiDB

**–û–ø–∏—Å–∞–Ω–∏–µ:** MySQL-—Å–æ–≤–º–µ—Å—Ç–∏–º–∞—è NewSQL –æ—Ç PingCAP.

**–û—Å–æ–±–µ–Ω–Ω–æ—Å—Ç–∏:**
- MySQL wire protocol (–ø–æ–¥–∫–ª—é—á–∞–µ—à—å—Å—è –∫–∞–∫ –∫ MySQL)
- HTAP (Hybrid Transactional/Analytical Processing)
- TiKV –¥–ª—è —Ö—Ä–∞–Ω–µ–Ω–∏—è (key-value –¥–≤–∏–∂–æ–∫)
- TiFlash –¥–ª—è –∞–Ω–∞–ª–∏—Ç–∏–∫–∏
- Open source

**–ü—Ä–∏–º–µ—Ä:**
```sql
-- –û–±—ã—á–Ω—ã–π MySQL —Å–∏–Ω—Ç–∞–∫—Å–∏—Å
CREATE TABLE orders (
    id BIGINT AUTO_INCREMENT PRIMARY KEY,
    user_id BIGINT NOT NULL,
    total DECIMAL(10,2),
    created_at DATETIME DEFAULT CURRENT_TIMESTAMP,
    INDEX idx_user_id (user_id)
);

-- –†–∞–±–æ—Ç–∞–µ—Ç –¥–∞–∂–µ JOIN –∏ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏
BEGIN;
    INSERT INTO orders (user_id, total) VALUES (123, 99.99);
    UPDATE inventory SET stock = stock - 1 WHERE product_id = 456;
COMMIT;
```

### 5. VoltDB

**–û–ø–∏—Å–∞–Ω–∏–µ:** In-memory NewSQL –¥–ª—è –≤—ã—Å–æ–∫–æ–ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω—ã—Ö workloads.

**–û—Å–æ–±–µ–Ω–Ω–æ—Å—Ç–∏:**
- –í—Å–µ –¥–∞–Ω–Ω—ã–µ –≤ RAM (–æ—á–µ–Ω—å –±—ã—Å—Ç—Ä–æ)
- Stored procedures –Ω–∞ Java
- Deterministic execution
- –ü–∞—Ä—Ç–∏—Ü–∏–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ –ø–æ –∫–ª—é—á—É

---

## üîÑ –ö–∞–∫ —Ä–∞–±–æ—Ç–∞–µ—Ç —Ä–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–Ω–æ—Å—Ç—å –≤ NewSQL

### –†–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–Ω—ã–µ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏ (2PC - Two-Phase Commit)

```
Client                Node 1 (Coordinator)     Node 2           Node 3
  ‚îÇ                          ‚îÇ                   ‚îÇ                ‚îÇ
  ‚îú‚îÄ BEGIN                   ‚îÇ                   ‚îÇ                ‚îÇ
  ‚îú‚îÄ INSERT users ...‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ>‚îÇ                   ‚îÇ                ‚îÇ
  ‚îÇ                          ‚îú‚îÄ Prepare ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ>‚îÇ                ‚îÇ
  ‚îÇ                          ‚îú‚îÄ Prepare ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ>‚îÇ
  ‚îÇ                          ‚îÇ                   ‚îÇ                ‚îÇ
  ‚îÇ                          ‚îÇ<‚îÄ‚îÄ‚îÄ OK ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§                ‚îÇ
  ‚îÇ                          ‚îÇ<‚îÄ‚îÄ‚îÄ OK ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§
  ‚îú‚îÄ COMMIT ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ>‚îÇ                   ‚îÇ                ‚îÇ
  ‚îÇ                          ‚îú‚îÄ Commit ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ>‚îÇ                ‚îÇ
  ‚îÇ                          ‚îú‚îÄ Commit ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ>‚îÇ
  ‚îÇ<‚îÄ OK ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§                   ‚îÇ                ‚îÇ
```

**–§–∞–∑—ã:**
1. **Prepare Phase** - –≤—Å–µ —É–∑–ª—ã –≥–æ—Ç–æ–≤—è—Ç—Å—è –∫ –∫–æ–º–º–∏—Ç—É
2. **Commit Phase** - –µ—Å–ª–∏ –≤—Å–µ OK, –≤—Å–µ —É–∑–ª—ã –∫–æ–º–º–∏—Ç—è—Ç

**–ü—Ä–æ–±–ª–µ–º—ã:**
- –ë–ª–æ–∫–∏—Ä–æ–≤–∫–∏ –¥–µ—Ä–∂–∞—Ç—Å—è –¥–æ–ª—å—à–µ
- –ï—Å–ª–∏ coordinator —É–ø–∞–ª = —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏—è –≤–∏—Å–∏—Ç
- –†–µ—à–µ–Ω–∏–µ: 3PC (Three-Phase Commit) –∏–ª–∏ Raft consensus

### Consensus –ø—Ä–æ—Ç–æ–∫–æ–ª—ã: Raft

```
Node 1 (Leader)        Node 2 (Follower)      Node 3 (Follower)
     ‚îÇ                        ‚îÇ                        ‚îÇ
     ‚îú‚îÄ Write request         ‚îÇ                        ‚îÇ
     ‚îú‚îÄ AppendEntries ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ>‚îÇ                        ‚îÇ
     ‚îú‚îÄ AppendEntries ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ>‚îÇ
     ‚îÇ                        ‚îÇ                        ‚îÇ
     ‚îÇ<‚îÄ‚îÄ‚îÄ ACK ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§                        ‚îÇ
     ‚îÇ<‚îÄ‚îÄ‚îÄ ACK ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§
     ‚îú‚îÄ Commit (majority OK)  ‚îÇ                        ‚îÇ
     ‚îú‚îÄ Notify ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ>‚îÇ                        ‚îÇ
     ‚îú‚îÄ Notify ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ>‚îÇ
```

**–ö–ª—é—á–µ–≤—ã–µ –º–æ–º–µ–Ω—Ç—ã:**
- –¢–æ–ª—å–∫–æ leader –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç writes
- Majority (–∫–≤–æ—Ä—É–º) –¥–æ–ª–∂–Ω—ã —Å–æ–≥–ª–∞—Å–∏—Ç—å—Å—è
- –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π leader election –ø—Ä–∏ –ø–∞–¥–µ–Ω–∏–∏

---

## üìä –°—Ä–∞–≤–Ω–µ–Ω–∏–µ NewSQL –±–∞–∑ –¥–∞–Ω–Ω—ã—Ö

| –•–∞—Ä–∞–∫—Ç–µ—Ä–∏—Å—Ç–∏–∫–∞ | CockroachDB | Google Spanner | YugabyteDB | TiDB |
|----------------|-------------|----------------|------------|------|
| **SQL –¥–∏–∞–ª–µ–∫—Ç** | PostgreSQL | Google SQL | PostgreSQL | MySQL |
| **Open Source** | ‚úÖ (BSL) | ‚ùå | ‚úÖ (Apache 2.0) | ‚úÖ (Apache 2.0) |
| **On-premise** | ‚úÖ | ‚ùå | ‚úÖ | ‚úÖ |
| **Cloud** | ‚úÖ | ‚úÖ (—Ç–æ–ª—å–∫–æ GCP) | ‚úÖ | ‚úÖ |
| **Consistency** | Serializable | External | Serializable | Snapshot Isolation |
| **Geo-replication** | ‚úÖ | ‚úÖ | ‚úÖ | ‚úÖ |
| **HTAP** | ‚ö†Ô∏è –û–≥—Ä–∞–Ω–∏—á–µ–Ω–æ | ‚ö†Ô∏è | ‚úÖ | ‚úÖ |
| **–¶–µ–Ω–∞** | –°—Ä–µ–¥–Ω—è—è | –û—á–µ–Ω—å –≤—ã—Å–æ–∫–∞—è | –ù–∏–∑–∫–∞—è | –ù–∏–∑–∫–∞—è |

---

## üöÄ –ö–æ–≥–¥–∞ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å NewSQL

### ‚úÖ –•–æ—Ä–æ—à–∏–µ —Å—Ü–µ–Ω–∞—Ä–∏–∏:

1. **–ì–ª–æ–±–∞–ª—å–Ω—ã–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è**
   ```
   –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏ –≤ –°–®–ê, –ï–≤—Ä–æ–ø–µ, –ê–∑–∏–∏
   ‚Üí CockroachDB —Å geo-partitioning
   ‚Üí Latency –æ–ø—Ç–∏–º–∏–∑–∏—Ä—É–µ—Ç—Å—è –¥–ª—è –∫–∞–∂–¥–æ–≥–æ —Ä–µ–≥–∏–æ–Ω–∞
   ```

2. **High availability –∫—Ä–∏—Ç–∏—á–Ω–∞**
   ```
   E-commerce, —Ñ–∏–Ω—Ç–µ—Ö, –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∞—è –∏–Ω—Ñ—Ä–∞—Å—Ç—Ä—É–∫—Ç—É—Ä–∞
   ‚Üí –í—ã–¥–µ—Ä–∂–∏–≤–∞–µ—Ç –ø–∞–¥–µ–Ω–∏–µ —Ü–µ–ª–æ–≥–æ –¥–∞—Ç–∞-—Ü–µ–Ω—Ç—Ä–∞
   ‚Üí 99.99%+ uptime
   ```

3. **–†–∞—Å—Ç—É—â–∏–µ –¥–∞–Ω–Ω—ã–µ**
   ```
   –ù–∞—á–∞–ª–∏ —Å 10GB, —Ä–∞—Å—Ç–µ–º –¥–æ 10TB
   ‚Üí –ì–æ—Ä–∏–∑–æ–Ω—Ç–∞–ª—å–Ω–æ–µ –º–∞—Å—à—Ç–∞–±–∏—Ä–æ–≤–∞–Ω–∏–µ (–¥–æ–±–∞–≤–ª—è–π —É–∑–ª—ã)
   ‚Üí –ù–µ –Ω—É–∂–Ω–æ –ø–µ—Ä–µ–ø–∏—Å—ã–≤–∞—Ç—å –Ω–∞ NoSQL
   ```

4. **–°–ª–æ–∂–Ω—ã–µ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏**
   ```
   –§–∏–Ω–∞–Ω—Å—ã, –±–∞–Ω–∫–∏–Ω–≥, –∏–Ω–≤–µ–Ω—Ç–∞—Ä–∏–∑–∞—Ü–∏—è
   ‚Üí ACID –≥–∞—Ä–∞–Ω—Ç–∏–∏ –¥–∞–∂–µ –≤ —Ä–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–Ω–æ–π —Å–∏—Å—Ç–µ–º–µ
   ‚Üí –ù–µ eventual consistency –∫–∞–∫ –≤ Cassandra
   ```

### ‚ùå –ü–ª–æ—Ö–∏–µ —Å—Ü–µ–Ω–∞—Ä–∏–∏:

1. **–ú–∞–ª–µ–Ω—å–∫–∏–π –ø—Ä–æ–µ–∫—Ç**
   ```
   –ü—Ä–æ—Å—Ç–æ–π CRUD, < 100GB –¥–∞–Ω–Ω—ã—Ö
   ‚Üí Overkill, –∏—Å–ø–æ–ª—å–∑—É–π PostgreSQL
   ‚Üí –ò–∑–ª–∏—à–Ω—è—è —Å–ª–æ–∂–Ω–æ—Å—Ç—å
   ```

2. **–û—á–µ–Ω—å –Ω–∏–∑–∫–∞—è latency**
   ```
   HFT (High-Frequency Trading), gaming
   ‚Üí Distributed consensus –¥–æ–±–∞–≤–ª—è–µ—Ç –∑–∞–¥–µ—Ä–∂–∫–∏ (5-50ms)
   ‚Üí –ò—Å–ø–æ–ª—å–∑—É–π in-memory –ë–î –∏–ª–∏ Redis
   ```

3. **–û–≥—Ä–∞–Ω–∏—á–µ–Ω–Ω—ã–π –±—é–¥–∂–µ—Ç**
   ```
   –°—Ç–∞—Ä—Ç–∞–ø, MVP
   ‚Üí 3-5 —É–∑–ª–æ–≤ = –¥–æ—Ä–æ–∂–µ —á–µ–º 1 –º–æ—â–Ω—ã–π Postgres
   ‚Üí –ù–∞—á–Ω–∏ —Å Postgres, –º–∏–≥—Ä–∏—Ä—É–π –ø—Ä–∏ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ—Å—Ç–∏
   ```

4. **–ê–Ω–∞–ª–∏—Ç–∏–∫–∞ (OLAP)**
   ```
   Data warehouse, BI, –æ—Ç—á–µ—Ç—ã
   ‚Üí –ò—Å–ø–æ–ª—å–∑—É–π ClickHouse –∏–ª–∏ BigQuery
   ‚Üí NewSQL –æ–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞–Ω—ã –¥–ª—è OLTP
   ```

---

## üèóÔ∏è –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è —Å NewSQL

### Laravel + CockroachDB

```php
// .env
DB_CONNECTION=pgsql  // CockroachDB –∏—Å–ø–æ–ª—å–∑—É–µ—Ç PostgreSQL protocol
DB_HOST=cockroach-lb.example.com
DB_PORT=26257
DB_DATABASE=myapp
DB_USERNAME=root
DB_PASSWORD=secret
```

```php
// config/database.php
'pgsql' => [
    'driver' => 'pgsql',
    'url' => env('DATABASE_URL'),
    'host' => env('DB_HOST', 'localhost'),
    'port' => env('DB_PORT', '26257'),
    'database' => env('DB_DATABASE', 'forge'),
    'username' => env('DB_USERNAME', 'forge'),
    'password' => env('DB_PASSWORD', ''),
    'charset' => 'utf8',
    'prefix' => '',
    'schema' => 'public',
    'sslmode' => 'require',
    'options' => [
        // CockroachDB retries —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏
        PDO::ATTR_EMULATE_PREPARES => true,
    ],
],
```

```php
// –ú–∏–≥—Ä–∞—Ü–∏–∏ - –æ–±—ã—á–Ω—ã–µ Laravel
Schema::create('orders', function (Blueprint $table) {
    $table->uuid('id')->primary();
    $table->foreignUuid('user_id')->constrained();
    $table->decimal('total', 10, 2);
    $table->timestamp('created_at')->useCurrent();
    
    // Geo-partitioning –¥–ª—è –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏
    // ALTER TABLE orders PARTITION BY LIST (region) ...
});
```

```php
// –ú–æ–¥–µ–ª–∏ - –æ–±—ã—á–Ω—ã–π Eloquent
class Order extends Model
{
    protected $keyType = 'string'; // UUID
    public $incrementing = false;
    
    protected static function booted()
    {
        static::creating(function ($order) {
            $order->id = Str::uuid();
        });
    }
    
    // –¢—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏ —Ä–∞–±–æ—Ç–∞—é—Ç –∫–∞–∫ –æ–±—ã—á–Ω–æ
    public static function createWithPayment($userId, $total)
    {
        return DB::transaction(function () use ($userId, $total) {
            $order = Order::create([
                'user_id' => $userId,
                'total' => $total,
            ]);
            
            // ACID –≥–∞—Ä–∞–Ω—Ç–∏—Ä—É–µ—Ç—Å—è –¥–∞–∂–µ –µ—Å–ª–∏ —É–∑–ª—ã –≤ —Ä–∞–∑–Ω—ã—Ö —Ä–µ–≥–∏–æ–Ω–∞—Ö!
            Payment::create([
                'order_id' => $order->id,
                'amount' => $total,
            ]);
            
            return $order;
        });
    }
}
```

### –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥

```sql
-- CockroachDB Admin UI: http://localhost:8080

-- –ü–æ—Å–º–æ—Ç—Ä–µ—Ç—å —Ä–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö –ø–æ —É–∑–ª–∞–º
SHOW RANGES FROM TABLE orders;

-- –ú–µ—Ç—Ä–∏–∫–∏ —Ä–µ–ø–ª–∏–∫–∞—Ü–∏–∏
SELECT * FROM crdb_internal.cluster_replication_status;

-- –ê–∫—Ç–∏–≤–Ω—ã–µ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏
SELECT * FROM crdb_internal.node_transactions;

-- Slow queries
SELECT query, count, avg_latency_seconds
FROM crdb_internal.statement_statistics
WHERE avg_latency_seconds > 1
ORDER BY avg_latency_seconds DESC;
```

---

## ‚öñÔ∏è –ú–∏–≥—Ä–∞—Ü–∏—è —Å PostgreSQL –Ω–∞ CockroachDB

### 1. –°–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç—å

**–ß—Ç–æ —Ä–∞–±–æ—Ç–∞–µ—Ç –∏–∑ –∫–æ—Ä–æ–±–∫–∏:**
- ‚úÖ –ë–∞–∑–æ–≤—ã–π SQL (SELECT, INSERT, UPDATE, DELETE)
- ‚úÖ JOINs, –ø–æ–¥–∑–∞–ø—Ä–æ—Å—ã, CTEs
- ‚úÖ –ò–Ω–¥–µ–∫—Å—ã (B-Tree)
- ‚úÖ Foreign keys
- ‚úÖ –¢—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏
- ‚úÖ JSON/JSONB

**–ß—Ç–æ —Ç—Ä–µ–±—É–µ—Ç –∏–∑–º–µ–Ω–µ–Ω–∏–π:**
- ‚ö†Ô∏è SERIAL ‚Üí UUID (—Ä–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è)
- ‚ö†Ô∏è –ù–µ–∫–æ—Ç–æ—Ä—ã–µ PostgreSQL —Ä–∞—Å—à–∏—Ä–µ–Ω–∏—è (PostGIS —á–∞—Å—Ç–∏—á–Ω–æ)
- ‚ö†Ô∏è Stored procedures (–æ–≥—Ä–∞–Ω–∏—á–µ–Ω—ã)
- ‚ö†Ô∏è INTERLEAVE (deprecated –≤ –Ω–æ–≤—ã—Ö –≤–µ—Ä—Å–∏—è—Ö)

### 2. –ü–æ—à–∞–≥–æ–≤–∞—è –º–∏–≥—Ä–∞—Ü–∏—è

```sql
-- 1. –≠–∫—Å–ø–æ—Ä—Ç –∏–∑ PostgreSQL
pg_dump -h localhost -U postgres mydb > dump.sql

-- 2. –ê–¥–∞–ø—Ç–∞—Ü–∏—è —Å—Ö–µ–º—ã –¥–ª—è CockroachDB
-- –ó–∞–º–µ–Ω–∞ SERIAL –Ω–∞ UUID
-- –î–æ:
CREATE TABLE users (
    id SERIAL PRIMARY KEY,
    email VARCHAR(255)
);

-- –ü–æ—Å–ª–µ:
CREATE TABLE users (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    email STRING(255)  -- CockroachDB –∏—Å–ø–æ–ª—å–∑—É–µ—Ç STRING, –Ω–µ VARCHAR
);

-- 3. –ò–º–ø–æ—Ä—Ç –≤ CockroachDB
cockroach sql --insecure < adapted_dump.sql

-- 4. –î–æ–±–∞–≤–ª–µ–Ω–∏–µ geo-partitioning (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)
ALTER TABLE users PARTITION BY LIST (region) (
    PARTITION us VALUES IN ('us-east', 'us-west'),
    PARTITION eu VALUES IN ('eu-west')
);
```

---

## üîß –û–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏

### 1. –ò—Å–ø–æ–ª—å–∑—É–π UUID –≤–º–µ—Å—Ç–æ SERIAL

```sql
-- –ü–ª–æ—Ö–æ: SERIAL —Å–æ–∑–¥–∞–µ—Ç hotspot (–≤—Å–µ INSERT –≤ –æ–¥–Ω—É range)
CREATE TABLE orders (
    id SERIAL PRIMARY KEY,
    user_id INT
);

-- –•–æ—Ä–æ—à–æ: UUID —Ä–∞—Å–ø—Ä–µ–¥–µ–ª—è–µ—Ç –¥–∞–Ω–Ω—ã–µ —Ä–∞–≤–Ω–æ–º–µ—Ä–Ω–æ
CREATE TABLE orders (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    user_id UUID
);
```

### 2. Geo-partitioning –¥–ª—è latency

```sql
-- –ü—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –≤ –°–®–ê –∏ –ï–≤—Ä–æ–ø–µ
ALTER TABLE users PARTITION BY LIST (region) (
    PARTITION us VALUES IN ('us-east', 'us-west'),
    PARTITION eu VALUES IN ('eu-west', 'eu-central')
);

-- –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏ –∏–∑ –°–®–ê ‚Üí –¥–∞–Ω–Ω—ã–µ –≤ US —Ä–µ–≥–∏–æ–Ω–µ
-- –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏ –∏–∑ EU ‚Üí –¥–∞–Ω–Ω—ã–µ –≤ EU —Ä–µ–≥–∏–æ–Ω–µ
-- Latency —Å–Ω–∏–∂–∞–µ—Ç—Å—è –Ω–∞ 10x!
```

### 3. Read-only optimization

```sql
-- –î–ª—è read-heavy workloads
SET TRANSACTION AS OF SYSTEM TIME '-5s';
SELECT * FROM products WHERE category = 'electronics';

-- –ß–∏—Ç–∞–µ—Ç —Å–ª–µ–≥–∫–∞ —É—Å—Ç–∞—Ä–µ–≤—à–∏–µ –¥–∞–Ω–Ω—ã–µ (5 —Å–µ–∫ –Ω–∞–∑–∞–¥)
-- –ù–µ –∂–¥–µ—Ç –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è –æ—Ç –≤—Å–µ—Ö —Ä–µ–ø–ª–∏–∫
-- Latency –Ω–∏–∂–µ, throughput –≤—ã—à–µ
```

### 4. Follower reads

```sql
-- –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –≤ CockroachDB
ALTER TABLE products CONFIGURE ZONE USING num_replicas = 5;

-- –ß—Ç–µ–Ω–∏–µ —Å –±–ª–∏–∂–∞–π—à–µ–π —Ä–µ–ø–ª–∏–∫–∏ (–Ω–µ —Ç–æ–ª—å–∫–æ leader)
SET enable_follower_reads = on;
SELECT * FROM products WHERE id = 'abc-123';
-- –ß–∏—Ç–∞–µ—Ç —Å –ª–æ–∫–∞–ª—å–Ω–æ–π —Ä–µ–ø–ª–∏–∫–∏ ‚Üí –º–µ–Ω—å—à–µ latency
```

---

## üéì –õ—É—á—à–∏–µ –ø—Ä–∞–∫—Ç–∏–∫–∏

### 1. –î–∏–∑–∞–π–Ω —Å—Ö–µ–º—ã

```sql
-- ‚úÖ –•–æ—Ä–æ—à–æ: UUID –¥–ª—è —Ä–∞–≤–Ω–æ–º–µ—Ä–Ω–æ–≥–æ —Ä–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—è
CREATE TABLE events (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    user_id UUID NOT NULL,
    event_type STRING NOT NULL,
    created_at TIMESTAMP DEFAULT now(),
    INDEX idx_user_events (user_id, created_at DESC)
);

-- ‚ùå –ü–ª–æ—Ö–æ: SERIAL —Å–æ–∑–¥–∞–µ—Ç hotspot
CREATE TABLE events (
    id SERIAL PRIMARY KEY,  -- –í—Å–µ INSERT –∏–¥—É—Ç –≤ –∫–æ–Ω–µ—Ü —Ç–∞–±–ª–∏—Ü—ã
    user_id INT,
    created_at TIMESTAMP
);
```

### 2. –†–∞–∑–º–µ—Ä —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–π

```sql
-- ‚ùå –ü–ª–æ—Ö–æ: –æ–≥—Ä–æ–º–Ω–∞—è —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏—è
BEGIN;
    -- 10,000 INSERT –ø–æ–¥—Ä—è–¥
    INSERT INTO logs VALUES (...);  -- √ó 10,000
COMMIT;
-- –î–µ—Ä–∂–∏—Ç –±–ª–æ–∫–∏—Ä–æ–≤–∫–∏ –¥–æ–ª–≥–æ, –º–æ–∂–µ—Ç —É–ø–∞—Å—Ç—å

-- ‚úÖ –•–æ—Ä–æ—à–æ: –±–∞—Ç—á–∏ –ø–æ 100-500 —Å—Ç—Ä–æ–∫
BEGIN;
    INSERT INTO logs VALUES (...);  -- √ó 500
COMMIT;
-- –ü–æ–≤—Ç–æ—Ä–∏—Ç—å 20 —Ä–∞–∑
```

### 3. Retry logic

```php
// CockroachDB –º–æ–∂–µ—Ç –≤–µ—Ä–Ω—É—Ç—å "retry transaction" error
DB::transaction(function () {
    // your logic
}, 5);  // –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ retry –¥–æ 5 —Ä–∞–∑

// –ò–ª–∏ –≤—Ä—É—á–Ω—É—é
use Illuminate\Database\QueryException;

$maxRetries = 5;
$attempt = 0;

while ($attempt < $maxRetries) {
    try {
        DB::transaction(function () {
            Order::create([...]);
        });
        break;  // —É—Å–ø–µ—Ö
    } catch (QueryException $e) {
        if (str_contains($e->getMessage(), 'restart transaction')) {
            $attempt++;
            usleep(100000 * $attempt);  // exponential backoff
            continue;
        }
        throw $e;
    }
}
```

---

## üÜö NewSQL vs PostgreSQL vs NoSQL

| –ö—Ä–∏—Ç–µ—Ä–∏–π | PostgreSQL | CockroachDB (NewSQL) | MongoDB (NoSQL) |
|----------|------------|----------------------|-----------------|
| **SQL** | ‚úÖ –ü–æ–ª–Ω—ã–π | ‚úÖ PostgreSQL —Å–æ–≤–º–µ—Å—Ç–∏–º—ã–π | ‚ùå –°–≤–æ–π —è–∑—ã–∫ |
| **ACID** | ‚úÖ –î–∞ | ‚úÖ –î–∞ (distributed) | ‚ö†Ô∏è –û–≥—Ä–∞–Ω–∏—á–µ–Ω–Ω–æ |
| **–°—Ö–µ–º–∞** | ‚úÖ –°—Ç—Ä–æ–≥–∞—è | ‚úÖ –°—Ç—Ä–æ–≥–∞—è | ‚ùå Schema-less |
| **–ú–∞—Å—à—Ç–∞–±–∏—Ä–æ–≤–∞–Ω–∏–µ** | ‚ö†Ô∏è –í–µ—Ä—Ç–∏–∫–∞–ª—å–Ω–æ–µ | ‚úÖ –ì–æ—Ä–∏–∑–æ–Ω—Ç–∞–ª—å–Ω–æ–µ | ‚úÖ –ì–æ—Ä–∏–∑–æ–Ω—Ç–∞–ª—å–Ω–æ–µ |
| **–†–µ–ø–ª–∏–∫–∞—Ü–∏—è** | ‚ö†Ô∏è –í—Ä—É—á–Ω—É—é (streaming) | ‚úÖ –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è | ‚úÖ –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è |
| **Multi-region** | ‚ùå –°–ª–æ–∂–Ω–æ | ‚úÖ –ò–∑ –∫–æ—Ä–æ–±–∫–∏ | ‚úÖ –ò–∑ –∫–æ—Ä–æ–±–∫–∏ |
| **Consistency** | ‚úÖ Strong | ‚úÖ Strong | ‚ö†Ô∏è Eventual (–ø–æ —É–º–æ–ª—á–∞–Ω–∏—é) |
| **Latency** | üü¢ –ù–∏–∑–∫–∞—è | üü° –°—Ä–µ–¥–Ω—è—è | üü¢ –ù–∏–∑–∫–∞—è |
| **–°–ª–æ–∂–Ω–æ—Å—Ç—å** | üü¢ –ü—Ä–æ—Å—Ç–∞—è | üî¥ –í—ã—Å–æ–∫–∞—è | üü° –°—Ä–µ–¥–Ω—è—è |
| **–¶–µ–Ω–∞** | üí∞ –ù–∏–∑–∫–∞—è | üí∞üí∞ –°—Ä–µ–¥–Ω—è—è/–í—ã—Å–æ–∫–∞—è | üí∞ –ù–∏–∑–∫–∞—è |

### –ö–æ–≥–¥–∞ —á—Ç–æ –≤—ã–±—Ä–∞—Ç—å:

**PostgreSQL:**
- –¢—Ä–∞–¥–∏—Ü–∏–æ–Ω–Ω–æ–µ –≤–µ–±-–ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ
- –î–∞–Ω–Ω—ã–µ –ø–æ–º–µ—â–∞—é—Ç—Å—è –Ω–∞ 1 —Å–µ—Ä–≤–µ—Ä (< 1TB)
- –ù–µ –∫—Ä–∏—Ç–∏—á–Ω–∞ geographic distribution
- –ë—é–¥–∂–µ—Ç –æ–≥—Ä–∞–Ω–∏—á–µ–Ω

**CockroachDB (NewSQL):**
- –ì–ª–æ–±–∞–ª—å–Ω–æ–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ (–ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏ –≤–µ–∑–¥–µ)
- –ö—Ä–∏—Ç–∏—á–Ω–∞ –≤—ã—Å–æ–∫–∞—è –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç—å
- –†–∞—Å—Ç—É—â–∏–µ –¥–∞–Ω–Ω—ã–µ (>1TB)
- –ù—É–∂–µ–Ω SQL + —Ä–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–Ω–æ—Å—Ç—å

**MongoDB (NoSQL):**
- –ì–∏–±–∫–∞—è —Å—Ö–µ–º–∞ –¥–∞–Ω–Ω—ã—Ö
- –û—á–µ–Ω—å high throughput writes
- Eventual consistency –ø—Ä–∏–µ–º–ª–µ–º–∞
- Document-oriented –¥–∞–Ω–Ω—ã–µ

---

## üìö –†–µ—Å—É—Ä—Å—ã –¥–ª—è –∏–∑—É—á–µ–Ω–∏—è

### –î–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è:
- [CockroachDB Docs](https://www.cockroachlabs.com/docs/)
- [Google Spanner Docs](https://cloud.google.com/spanner/docs)
- [YugabyteDB Docs](https://docs.yugabyte.com/)
- [TiDB Docs](https://docs.pingcap.com/)

### –°—Ç–∞—Ç—å–∏ –∏ –≤–∏–¥–µ–æ:
- [Google Spanner Paper](https://research.google/pubs/pub39966/) - –æ—Ä–∏–≥–∏–Ω–∞–ª—å–Ω–∞—è —Å—Ç–∞—Ç—å—è
- [CockroachDB Architecture](https://www.cockroachlabs.com/docs/stable/architecture/overview.html)
- [CAP Theorem in NewSQL](https://blog.yugabyte.com/cap-theorem-and-distributed-databases/)

### –ö—É—Ä—Å—ã:
- [CockroachDB University](https://university.cockroachlabs.com/) - –±–µ—Å–ø–ª–∞—Ç–Ω—ã–µ –∫—É—Ä—Å—ã

---

## üéØ –ì–ª–∞–≤–Ω–æ–µ –¥–ª—è —Å–æ–±–µ—Å–µ–¥–æ–≤–∞–Ω–∏—è

1. **NewSQL = SQL + –†–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–Ω–æ—Å—Ç—å** - –ø–æ–Ω–∏–º–∞–π —ç—Ç—É –∫–æ–Ω—Ü–µ–ø—Ü–∏—é
2. **ACID –≤ —Ä–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–Ω–æ–π —Å–∏—Å—Ç–µ–º–µ** - –∫–∞–∫ —ç—Ç–æ —Ä–∞–±–æ—Ç–∞–µ—Ç (2PC, Raft)
3. **–ö–æ–≥–¥–∞ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å** - –≥–ª–æ–±–∞–ª—å–Ω—ã–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è, high availability
4. **Trade-offs** - latency –≤—ã—à–µ, —Å–ª–æ–∂–Ω–æ—Å—Ç—å –≤—ã—à–µ, –Ω–æ –º–∞—Å—à—Ç–∞–±–∏—Ä—É–µ–º–æ—Å—Ç—å –ª—É—á—à–µ
5. **CockroachDB** - –∑–Ω–∞–π —Ö–æ—Ç—è –±—ã –æ–¥–Ω—É NewSQL –ë–î –¥–µ—Ç–∞–ª—å–Ω–æ
6. **–û—Ç–ª–∏—á–∏—è –æ—Ç NoSQL** - strong consistency vs eventual consistency
7. **Migration path** - –∫–∞–∫ –º–∏–≥—Ä–∏—Ä–æ–≤–∞—Ç—å —Å PostgreSQL –Ω–∞ CockroachDB

**–ö–ª—é—á–µ–≤—ã–µ –≤–æ–ø—Ä–æ—Å—ã:**
- –í —á–µ–º —Ä–∞–∑–Ω–∏—Ü–∞ –º–µ–∂–¥—É NewSQL –∏ NoSQL? ‚Üí Consistency –∏ SQL
- –ü–æ—á–µ–º—É –Ω–µ –≤—Å–µ –∏—Å–ø–æ–ª—å–∑—É—é—Ç NewSQL? ‚Üí –°–ª–æ–∂–Ω–æ—Å—Ç—å –∏ latency
- –ö–∞–∫ —Ä–∞–±–æ—Ç–∞—é—Ç distributed transactions? ‚Üí 2PC –∏–ª–∏ Raft consensus
- –ö–æ–≥–¥–∞ –≤—ã–±—Ä–∞—Ç—å CockroachDB –≤–º–µ—Å—Ç–æ PostgreSQL? ‚Üí Global scale, HA
—Ç–æ